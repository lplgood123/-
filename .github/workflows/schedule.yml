name: Medicine Reminder

on:
  schedule:
    # ⚠️ UTC时间 = 北京时间 - 8小时
    
    # --- 早上 08:00 档 ---
    - cron: '0 0 * * *'   # 08:00 提醒
    - cron: '30 0 * * *'  # 08:30 检查 (新增)
    
    # --- 上午 09:30 档 ---
    - cron: '30 1 * * *'  # 09:30 提醒
    - cron: '0 2 * * *'   # 10:00 检查 (新增)
    
    # --- 晚上 18:30 档 ---
    - cron: '30 10 * * *' # 18:30 提醒
    - cron: '0 11 * * *'  # 19:00 检查 (新增)
    
    # --- 晚上 22:30 档 ---
    - cron: '30 14 * * *' # 22:30 提醒
    - cron: '0 15 * * *'  # 23:00 检查 (新增)

  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test Type'
        required: true
        default: 'morning_8_check'

jobs:
  run-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install libraries
        run: pip install requests pytz

      - name: Run Reminder Script
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # 获取当前 UTC 小时和分钟
          h=$(date -u +%-H)
          m=$(date -u +%-M)
          
          # 手动测试通道
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             python main.py ${{ github.event.inputs.test_type }}
             exit 0
          fi

          # --- 智能时间判断逻辑 ---

          # 1. 早上 08:00 - 08:59 (UTC Hour 0)
          if [ "$h" -eq 0 ]; then
             if [ "$m" -lt 20 ]; then
                python main.py morning_8
             else
                python main.py morning_8_check
             fi
          
          # 2. 上午 09:30 (UTC Hour 1)
          elif [ "$h" -eq 1 ]; then
             python main.py morning_930
          
          # 3. 上午 10:00 (UTC Hour 2) - 检查
          elif [ "$h" -eq 2 ]; then
             python main.py morning_930_check

          # 4. 晚上 18:30 (UTC Hour 10)
          elif [ "$h" -eq 10 ]; then
             python main.py evening_1830

          # 5. 晚上 19:00 (UTC Hour 11) - 检查
          elif [ "$h" -eq 11 ]; then
             python main.py evening_1830_check

          # 6. 晚上 22:30 (UTC Hour 14)
          elif [ "$h" -eq 14 ]; then
             python main.py night_2230

          # 7. 晚上 23:00 (UTC Hour 15) - 检查
          elif [ "$h" -eq 15 ]; then
             python main.py night_2230_check
             
          else
             echo "非预定时间运行，跳过。"
          fi
